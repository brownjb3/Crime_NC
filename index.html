<!DOCTYPE html>
<html>
  <head>

    <title>North Carolina Crime</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.0/dist/leaflet.css"/>

    <style>

        html { height:100%;}

        body {height:100%;padding: 0;
          margin: 0;
}

        #map {
        width: 100%;
        height: 100%;
}

        .info.legend {
        background: white;
        padding: 10px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        line-height: 18px;
        color: #555;
}

        .info.legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.9;
}

        #map-title-bubble {
        position: absolute;
        top:60px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: black;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 30px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        z-index: 1000;
}

        .year-buttons {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
}
        .year-buttons button {
        margin-right: 5px;
        padding: 6px 10px;
        font-weight: bold;
}

    </style>

        <script src="https://unpkg.com/leaflet@1.7.0/dist/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>

  </head>
<body>

    <div id="map-title-bubble">Crimes in NC Counties</div>
    <div id="map"></div>
    
    <div class="year-buttons">
        <button onclick="show2023()">Show 2023</button>
        <button onclick="show2022()">Show 2022</button>
    </div>

    <div class='legend'></div>


    <script>

        var map = L.map('map').setView([35.306802, -79.350014], 8); 
        L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png').addTo(map);

        var currentProperty = "ChargesS";

        var previousCenter = map.getCenter();
    
        var previousZoom = map.getZoom();
     
        var grades = [0, 123, 274, 477, 745, 1066, 1435, 2335, 4655, 48545];
     
        var colors = [
        '#1a9850',  
        '#66bd63',
        '#a6d96a',
        '#d9ef8b',
        '#ffffbf',
        '#fee08b',
        '#fdae61',
        '#f46d43',
        '#d73027'   
        ];

     
      function getColor(d) {
            for (var i = 0; i < grades.length - 1; i++) {
            if ( d > grades[i] && d < grades[i+1] ) return colors[i];
            }
            if (d > grades[grades.length - 1]) return colors[grades.length];
}

     
      function makeStyle(propertyName) {
      return function(feature) {
        return {  
            weight: 2,
            opacity: 1,
            color: 'grey',
            dashArray: '3',
            fillOpacity: 0.9,
            fillColor: getColor(Number(feature.properties[propertyName]))
        };
    };
}

    function highlightFeature(e) { 
        var layer = e.target;
                  
            layer.setStyle({
            weight: 8,
            opacity: 0.8,
            color: '#e3e3e3',
            fillColor: '#1c5ee3',
            fillOpacity: 0.5
            });
   
    layer.bringToFront();
}

    function resetHighlight(e) {
    e.target.setStyle(e.target.featureStyle);
}

    function zoomToFeature(e) {
    previousCenter = map.getCenter();
    previousZoom = map.getZoom();

    map.fitBounds(e.target.getBounds());
}

function showPopupInfo(e) {
  var layer = e.target;
  var props = layer.feature.properties;
  var value = props["ChargesS"] ?? props["2022Offens"];
  var popupContent = "<strong>" + props.CountyName + "</strong><br>" +
    "Total Crimes: " + Number(value).toLocaleString();

  layer.bindPopup(popupContent).openPopup();
}
    
function makeOnEachFeature(propertyName) {
  return function(feature, layer) {
    layer.featureStyle = makeStyle(propertyName)(feature);
    layer.setStyle(layer.featureStyle);

    layer.bindTooltip(feature.properties.CountyName, {
      permanent: false,
      direction: 'top',
      className: 'county-tooltip'
    });

    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight,
      click: function(e) {
        currentProperty = propertyName;
        showPopupInfo(e);
        zoomToFeature(e);
      }
    });
  };
}

    map.on('popupclose', function () {
    map.setView(previousCenter, previousZoom);
    });

    let layer2023 = L.geoJson.ajax("data/2023Crime.geojson", {
  style: makeStyle("ChargesS"),
  onEachFeature: makeOnEachFeature("ChargesS")
}).addTo(map);

let layer2022 = L.geoJson.ajax("data/2022Crime.geojson", {
  style: makeStyle("2022Offens"),
  onEachFeature: makeOnEachFeature("2022Offens")
});

  function show2023() {
  currentProperty = "ChargesS";
  if (map.hasLayer(layer2022)) map.removeLayer(layer2022);
  if (!map.hasLayer(layer2023)) map.addLayer(layer2023);
}

function show2022() {
  currentProperty = "2022Offen";
  if (map.hasLayer(layer2023)) map.removeLayer(layer2023);
  if (!map.hasLayer(layer2022)) map.addLayer(layer2022);
}

    var legend = L.control({ position: 'bottomright' });

    legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        labels = [];

    for (var i = 0; i < grades.length - 1; i++) {
        labels.push(
        '<i style="background:' + colors[i] + '"></i> ' +
        grades[i] + ' â€“ ' + grades[i + 1]);
}

    labels.push('<i style="background:' + colors[grades.length - 1] + '"></i> ' +
        grades[grades.length - 1] + '+');

    div.innerHTML = '<strong>Total Crimes</strong><br>' + labels.join('<br>');
    return div;
};

legend.addTo(map);

      

      map.attributionControl.addAttribution('');

    </script>



</body>
</html>
